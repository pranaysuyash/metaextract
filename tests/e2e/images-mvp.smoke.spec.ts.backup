import { test, expect } from '@playwright/test';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

test('Images MVP smoke: login -> upload -> results render -> key field exists', async ({ page }) => {
  await page.goto('/images_mvp');

  // Log browser console to test output to help debug client-side errors
  page.on('console', msg => {
    try {
      const args = msg.args();
      const texts = args.map(a => a.toString()).join(' ');
      console.log('BROWSER_CONSOLE:', msg.type(), texts);
    } catch (e) {
      console.log('BROWSER_CONSOLE:', msg.type(), msg.text());
    }
  });

  // Login first
  await page.locator('[data-auth="login"]').click();
  await expect(page.locator('#login-email')).toBeVisible();
  await page.locator('#login-email').fill('test@metaextract.com');
  await page.locator('#login-password').fill('TestPassword123!');
  await page.locator('button[type="submit"]').click();

  // Wait for auth API response (more reliable than checking the success text)
  await page.waitForResponse(
    resp => resp.url().includes('/api/auth/login') && resp.status() === 200,
    { timeout: 10000 }
  );
  // Wait for modal to close
  await page.waitForSelector('[data-auth="login"]', { state: 'hidden' });

  // Reload to ensure auth state is updated
  await page.reload();

  const filePath = path.resolve(
    __dirname,
    'fixtures/images/iphone_exif.jpg'
  );
  const input = page.getByTestId('image-upload-input');
  await input.focus();
  await input.setInputFiles(filePath);

  await page.waitForTimeout(1000);

  await expect(page.getByText('iphone_exif.jpg')).toBeVisible({
    timeout: 60_000,
  });

  // Wait for dimensions to load
  await expect(page.getByText('dimensions pending')).not.toBeVisible({ timeout: 30_000 });

  // Wait for quote to load
  await expect(page.getByText('Credits:')).toBeVisible({ timeout: 30_000 });

  const analyzeButton = page.getByRole('button', { name: 'Analyze' });
  await expect(analyzeButton).toBeEnabled({ timeout: 60_000 });
  await analyzeButton.click();

  // Wait for server extraction response
  await page.waitForResponse(
    resp => resp.url().includes('/api/images_mvp/extract') && resp.status() === 200,
    { timeout: 60_000 }
  );

  // Wait for results page navigation and rendering
  await page.waitForURL('**/images_mvp/results', { timeout: 60_000 });

  // Debug: ensure metadata was stored in sessionStorage
  const stored = await page.evaluate(() => sessionStorage.getItem('currentMetadata'));
  console.log('STORED_LENGTH:', stored ? stored.length : 'null');
  expect(stored).toBeTruthy();

  // Debug: check for results-root existence in DOM
  const debug = await page.evaluate(() => {
    const el = document.querySelector('[data-testid="results-root"]');
    return {
      exists: !!el,
      htmlStart: document.body.innerHTML.slice(0, 2000),
    };
  });
  console.log('RESULTS_DEBUG:', debug.exists);
  // Attach the DOM snippet to test output for later inspection
  console.log('DOM_SNIPPET:', debug.htmlStart.replace(/\n/g, ' '));

  await expect(page.getByTestId('results-root')).toBeVisible({ timeout: 60_000 });
  await expect(page.getByTestId('key-field-mime-type')).toBeVisible();
});
