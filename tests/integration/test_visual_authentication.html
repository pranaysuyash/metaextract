<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaExtract - Visual Authentication Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #0B0C10 0%, #1a1a2e 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .header h1 {
            color: #6366f1;
            margin: 0;
            font-size: 2.5em;
        }
        .header p {
            color: #94a3b8;
            margin: 10px 0 0 0;
            font-size: 1.1em;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .test-panel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }
        .panel-header {
            color: #10b981;
            font-size: 1.4em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #10b981;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #6b7280;
            animation: pulse 2s infinite;
        }
        .status-indicator.online { background: #10b981; }
        .status-indicator.offline { background: #ef4444; }
        .status-indicator.warning { background: #f59e0b; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #e2e8f0;
            font-weight: 500;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px 8px 8px 0;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }
        .btn:disabled {
            background: #6b7280;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn.secondary {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        }
        .btn.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .btn.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .log-container {
            background: #000;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .log-entry {
            margin: 3px 0;
            padding: 2px 0;
        }
        .log-success { color: #10b981; }
        .log-error { color: #ef4444; }
        .log-warning { color: #f59e0b; }
        .log-info { color: #3b82f6; }
        .log-default { color: #94a3b8; }
        .user-info {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .user-info h4 {
            color: #10b981;
            margin: 0 0 10px 0;
        }
        .tier-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin: 4px;
        }
        .tier-free { background: #6b7280; color: white; }
        .tier-professional { background: #3b82f6; color: white; }
        .tier-forensic { background: #8b5cf6; color: white; }
        .tier-enterprise { background: #10b981; color: white; }
        .credentials-list {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .credentials-list h4 {
            color: #3b82f6;
            margin: 0 0 10px 0;
        }
        .credential-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 10px;
            margin: 8px 0;
            font-family: monospace;
            font-size: 13px;
        }
        .iframe-container {
            grid-column: 1 / -1;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.02);
        }
        .iframe-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .iframe-container iframe {
            width: 100%;
            height: 600px;
            border: none;
            background: white;
        }
        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #6366f1;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê MetaExtract Authentication Test</h1>
            <p>Visual testing interface for authentication system, tiers, and frontend integration</p>
            <div class="quick-actions">
                <button class="btn" onclick="runFullTest()">
                    <span id="full-test-icon">üß™</span> Run Full Test
                </button>
                <button class="btn secondary" onclick="openMainApp()">üñ•Ô∏è Open Main App</button>
                <button class="btn secondary" onclick="clearAllLogs()">üóëÔ∏è Clear Logs</button>
            </div>
        </div>

        <div class="test-grid">
            <!-- Server Status Panel -->
            <div class="test-panel">
                <div class="panel-header">
                    <span>üîß Server Status</span>
                    <div id="server-status" class="status-indicator"></div>
                </div>
                
                <button class="btn" onclick="checkServerHealth()">Check Health</button>
                <button class="btn secondary" onclick="detectAuthSystem()">Detect Auth System</button>
                
                <div id="server-info" style="margin-top: 15px;"></div>
                <div id="server-log" class="log-container"></div>
            </div>

            <!-- Authentication Panel -->
            <div class="test-panel">
                <div class="panel-header">
                    <span>üîê Authentication</span>
                    <div id="auth-status" class="status-indicator"></div>
                </div>
                
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="auth-email" placeholder="Enter email" value="test@metaextract.com">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="auth-password" placeholder="Enter password" value="testpassword123">
                </div>
                <div class="form-group">
                    <label>Username (for registration):</label>
                    <input type="text" id="auth-username" placeholder="Enter username" value="testuser">
                </div>
                
                <div class="quick-actions">
                    <button class="btn success" onclick="testLogin()">üîë Login</button>
                    <button class="btn" onclick="testRegister()">üìù Register</button>
                    <button class="btn danger" onclick="testLogout()">üö™ Logout</button>
                </div>
                
                <div id="current-user" class="user-info" style="display: none;">
                    <h4>Current User</h4>
                    <div id="user-details"></div>
                </div>
                
                <div id="auth-log" class="log-container"></div>
            </div>

            <!-- Tier Testing Panel -->
            <div class="test-panel">
                <div class="panel-header">
                    <span>üéØ Tier System</span>
                    <div id="tier-status" class="status-indicator"></div>
                </div>
                
                <div class="form-group">
                    <label>Test Tier:</label>
                    <select id="tier-select">
                        <option value="free">Free Tier</option>
                        <option value="professional">Professional</option>
                        <option value="forensic">Forensic</option>
                        <option value="enterprise">Enterprise</option>
                    </select>
                </div>
                
                <div class="quick-actions">
                    <button class="btn" onclick="testTierAccess()">üîç Test Access</button>
                    <button class="btn secondary" onclick="testAllTiers()">üéØ Test All Tiers</button>
                </div>
                
                <div style="margin: 15px 0;">
                    <strong>Available Tiers:</strong><br>
                    <span class="tier-badge tier-free">FREE</span>
                    <span class="tier-badge tier-professional">PROFESSIONAL</span>
                    <span class="tier-badge tier-forensic">FORENSIC</span>
                    <span class="tier-badge tier-enterprise">ENTERPRISE</span>
                </div>
                
                <div id="tier-log" class="log-container"></div>
            </div>

            <!-- File Processing Panel -->
            <div class="test-panel">
                <div class="panel-header">
                    <span>üìÅ File Processing</span>
                    <div id="file-status" class="status-indicator"></div>
                </div>
                
                <div class="form-group">
                    <label>Select File:</label>
                    <input type="file" id="file-input" accept="image/*,video/*,audio/*,.pdf" multiple>
                </div>
                
                <div class="quick-actions">
                    <button class="btn" onclick="testFileUpload()">üì§ Upload & Extract</button>
                    <button class="btn secondary" onclick="testAdvancedAnalysis()">üî¨ Advanced Analysis</button>
                    <button class="btn secondary" onclick="testForensicAnalysis()">üïµÔ∏è Forensic Analysis</button>
                </div>
                
                <div id="file-log" class="log-container"></div>
            </div>

            <!-- Test Credentials Panel -->
            <div class="test-panel">
                <div class="panel-header">
                    <span>üìã Test Credentials</span>
                    <div id="creds-status" class="status-indicator"></div>
                </div>
                
                <button class="btn" onclick="loadTestCredentials()">üîÑ Load Credentials</button>
                <button class="btn secondary" onclick="useCredentials('professional')">Use Professional</button>
                <button class="btn secondary" onclick="useCredentials('enterprise')">Use Enterprise</button>
                
                <div id="credentials-list" class="credentials-list">
                    <h4>Available Test Accounts</h4>
                    <p>Click "Load Credentials" to fetch available test accounts</p>
                </div>
                
                <div id="creds-log" class="log-container"></div>
            </div>

            <!-- System Information Panel -->
            <div class="test-panel">
                <div class="panel-header">
                    <span>‚ÑπÔ∏è System Information</span>
                    <div id="info-status" class="status-indicator"></div>
                </div>
                
                <button class="btn" onclick="getSystemInfo()">üìä Get System Info</button>
                <button class="btn secondary" onclick="testEndpoints()">üîó Test Endpoints</button>
                
                <div id="system-info"></div>
                <div id="info-log" class="log-container"></div>
            </div>
        </div>

        <!-- Live Frontend Preview -->
        <div class="iframe-container">
            <div class="iframe-header">
                <h3>üñ•Ô∏è Live Frontend Preview</h3>
                <div class="quick-actions">
                    <button class="btn secondary" onclick="refreshIframe()">üîÑ Refresh</button>
                    <button class="btn secondary" onclick="openInNewTab()">üîó Open in New Tab</button>
                </div>
            </div>
            <iframe id="frontend-iframe" src="http://localhost:3000" title="MetaExtract Frontend"></iframe>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let authToken = null;
        let authSystem = 'unknown';
        let testCredentials = {};

        // Utility functions
        function log(containerId, message, type = 'default') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `[${timestamp}] ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function setStatus(statusId, status) {
            const indicator = document.getElementById(statusId);
            indicator.className = `status-indicator ${status}`;
        }

        function clearLog(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        function clearAllLogs() {
            const logContainers = ['server-log', 'auth-log', 'tier-log', 'file-log', 'creds-log', 'info-log'];
            logContainers.forEach(clearLog);
        }

        // API helper
        async function apiCall(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                }
            };
            
            if (options.body && typeof options.body === 'object' && !(options.body instanceof FormData)) {
                options.body = JSON.stringify(options.body);
            }
            
            const response = await fetch(url, { ...defaultOptions, ...options });
            let data;
            
            try {
                data = await response.json();
            } catch {
                data = { message: 'No JSON response' };
            }
            
            return { response, data };
        }

        // Server health check
        async function checkServerHealth() {
            log('server-log', 'Checking server health...', 'info');
            setStatus('server-status', 'warning');
            
            try {
                const { response, data } = await apiCall('http://localhost:3000/api/health');
                
                if (response.ok) {
                    setStatus('server-status', 'online');
                    log('server-log', `‚úÖ Server healthy: ${data.service} v${data.version}`, 'success');
                    
                    document.getElementById('server-info').innerHTML = `
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 10px; border-radius: 6px; margin-top: 10px;">
                            <strong>Service:</strong> ${data.service}<br>
                            <strong>Version:</strong> ${data.version}<br>
                            <strong>Status:</strong> <span style="color: #10b981;">Online</span>
                        </div>
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                setStatus('server-status', 'offline');
                log('server-log', `‚ùå Health check failed: ${error.message}`, 'error');
            }
        }

        // Detect authentication system
        async function detectAuthSystem() {
            log('server-log', 'Detecting authentication system...', 'info');
            
            try {
                const { response, data } = await apiCall('http://localhost:3000/api/auth/dev/users');
                
                if (response.ok) {
                    authSystem = 'mock';
                    const users = data.users || [];
                    log('server-log', `‚úÖ Mock authentication system detected (${users.length} test users)`, 'success');
                    
                    // Store test credentials
                    testCredentials = {
                        professional: { email: 'test@metaextract.com', password: 'testpassword123', tier: 'professional' },
                        enterprise: { email: 'admin@metaextract.com', password: 'adminpassword123', tier: 'enterprise' },
                        forensic: { email: 'forensic@metaextract.com', password: 'forensicpassword123', tier: 'forensic' }
                    };
                    
                } else if (response.status === 404) {
                    authSystem = 'database';
                    log('server-log', '‚úÖ Database authentication system detected', 'success');
                } else {
                    authSystem = 'unknown';
                    log('server-log', `‚ö†Ô∏è Unknown authentication system (status: ${response.status})`, 'warning');
                }
            } catch (error) {
                log('server-log', `‚ùå Auth system detection failed: ${error.message}`, 'error');
            }
        }

        // Authentication functions
        async function testLogin() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            
            if (!email || !password) {
                log('auth-log', '‚ùå Please enter email and password', 'error');
                return;
            }
            
            log('auth-log', `Attempting login for ${email}...`, 'info');
            setStatus('auth-status', 'warning');
            
            try {
                const { response, data } = await apiCall('http://localhost:3000/api/auth/login', {
                    method: 'POST',
                    body: { email, password }
                });
                
                if (response.ok) {
                    currentUser = data.user;
                    authToken = data.token;
                    setStatus('auth-status', 'online');
                    log('auth-log', `‚úÖ Login successful: ${currentUser.username} (${currentUser.tier} tier)`, 'success');
                    
                    // Update user info display
                    document.getElementById('current-user').style.display = 'block';
                    document.getElementById('user-details').innerHTML = `
                        <strong>Username:</strong> ${currentUser.username}<br>
                        <strong>Email:</strong> ${currentUser.email}<br>
                        <strong>Tier:</strong> <span class="tier-badge tier-${currentUser.tier}">${currentUser.tier.toUpperCase()}</span><br>
                        <strong>Status:</strong> ${currentUser.subscriptionStatus || 'active'}
                    `;
                } else {
                    throw new Error(data.error || 'Login failed');
                }
            } catch (error) {
                setStatus('auth-status', 'offline');
                log('auth-log', `‚ùå Login failed: ${error.message}`, 'error');
            }
        }

        async function testRegister() {
            const email = document.getElementById('auth-email').value;
            const username = document.getElementById('auth-username').value;
            const password = document.getElementById('auth-password').value;
            
            if (!email || !username || !password) {
                log('auth-log', '‚ùå Please fill in all registration fields', 'error');
                return;
            }
            
            log('auth-log', `Attempting registration for ${email}...`, 'info');
            setStatus('auth-status', 'warning');
            
            try {
                const { response, data } = await apiCall('http://localhost:3000/api/auth/register', {
                    method: 'POST',
                    body: { email, username, password }
                });
                
                if (response.ok) {
                    currentUser = data.user;
                    authToken = data.token;
                    setStatus('auth-status', 'online');
                    log('auth-log', `‚úÖ Registration successful: ${currentUser.username}`, 'success');
                    
                    // Update user info display
                    document.getElementById('current-user').style.display = 'block';
                    document.getElementById('user-details').innerHTML = `
                        <strong>Username:</strong> ${currentUser.username}<br>
                        <strong>Email:</strong> ${currentUser.email}<br>
                        <strong>Tier:</strong> <span class="tier-badge tier-${currentUser.tier}">${currentUser.tier.toUpperCase()}</span><br>
                        <strong>Status:</strong> ${currentUser.subscriptionStatus || 'active'}
                    `;
                } else {
                    throw new Error(data.error || 'Registration failed');
                }
            } catch (error) {
                setStatus('auth-status', 'offline');
                log('auth-log', `‚ùå Registration failed: ${error.message}`, 'error');
            }
        }

        async function testLogout() {
            log('auth-log', 'Attempting logout...', 'info');
            
            try {
                await apiCall('http://localhost:3000/api/auth/logout', { method: 'POST' });
                
                currentUser = null;
                authToken = null;
                setStatus('auth-status', 'offline');
                log('auth-log', '‚úÖ Logout successful', 'success');
                
                // Hide user info
                document.getElementById('current-user').style.display = 'none';
            } catch (error) {
                log('auth-log', `‚ùå Logout failed: ${error.message}`, 'error');
            }
        }

        // Tier testing functions
        async function testTierAccess() {
            const tier = document.getElementById('tier-select').value;
            log('tier-log', `Testing ${tier} tier access...`, 'info');
            setStatus('tier-status', 'warning');
            
            const endpoints = [
                { name: 'Basic Extraction', url: '/api/extract', method: 'GET' },
                { name: 'Advanced Analysis', url: '/api/extract/advanced', method: 'GET' },
                { name: 'Forensic Capabilities', url: '/api/forensic/capabilities', method: 'GET' },
                { name: 'Forensic Report', url: '/api/forensic/report', method: 'GET' }
            ];
            
            let successCount = 0;
            
            for (const endpoint of endpoints) {
                try {
                    const url = `http://localhost:3000${endpoint.url}?tier=${tier}`;
                    const response = await fetch(url, { method: endpoint.method });
                    
                    if (response.status === 200 || response.status === 405) {
                        log('tier-log', `‚úÖ ${endpoint.name}: Accessible`, 'success');
                        successCount++;
                    } else if (response.status === 403) {
                        log('tier-log', `‚ö†Ô∏è ${endpoint.name}: Restricted`, 'warning');
                    } else {
                        log('tier-log', `‚ùå ${endpoint.name}: Error (${response.status})`, 'error');
                    }
                } catch (error) {
                    log('tier-log', `‚ùå ${endpoint.name}: ${error.message}`, 'error');
                }
            }
            
            setStatus('tier-status', successCount > 0 ? 'online' : 'offline');
            log('tier-log', `Tier test complete: ${successCount}/${endpoints.length} endpoints accessible`, 'info');
        }

        async function testAllTiers() {
            const tiers = ['free', 'professional', 'forensic', 'enterprise'];
            
            for (const tier of tiers) {
                log('tier-log', `--- Testing ${tier.toUpperCase()} tier ---`, 'info');
                document.getElementById('tier-select').value = tier;
                await testTierAccess();
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        // File processing functions
        async function testFileUpload() {
            const fileInput = document.getElementById('file-input');
            const files = fileInput.files;
            
            if (files.length === 0) {
                log('file-log', '‚ùå Please select a file first', 'error');
                return;
            }
            
            const file = files[0];
            log('file-log', `Uploading ${file.name} (${(file.size / 1024).toFixed(1)} KB)...`, 'info');
            setStatus('file-status', 'warning');
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('http://localhost:3000/api/extract?tier=free', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    setStatus('file-status', 'online');
                    log('file-log', `‚úÖ Upload successful: ${data.filename}`, 'success');
                    log('file-log', `Fields extracted: ${data.fields_extracted || 0}`, 'info');
                    
                    if (data.metadata) {
                        const metadataCount = Object.keys(data.metadata).length;
                        log('file-log', `Metadata sections: ${metadataCount}`, 'info');
                    }
                } else {
                    throw new Error(data.error || 'Upload failed');
                }
            } catch (error) {
                setStatus('file-status', 'offline');
                log('file-log', `‚ùå Upload failed: ${error.message}`, 'error');
            }
        }

        async function testAdvancedAnalysis() {
            log('file-log', 'Testing advanced analysis endpoint...', 'info');
            
            try {
                const response = await fetch('http://localhost:3000/api/extract/advanced?tier=professional');
                const data = await response.json();
                
                if (response.ok || response.status === 405) {
                    log('file-log', '‚úÖ Advanced analysis endpoint accessible', 'success');
                } else {
                    log('file-log', `‚ö†Ô∏è Advanced analysis: ${data.error || 'Access restricted'}`, 'warning');
                }
            } catch (error) {
                log('file-log', `‚ùå Advanced analysis test failed: ${error.message}`, 'error');
            }
        }

        async function testForensicAnalysis() {
            log('file-log', 'Testing forensic analysis capabilities...', 'info');
            
            try {
                const response = await fetch('http://localhost:3000/api/forensic/capabilities?tier=enterprise');
                const data = await response.json();
                
                if (response.ok) {
                    const modules = data.modules || [];
                    log('file-log', `‚úÖ Forensic capabilities: ${modules.length} modules available`, 'success');
                    
                    if (modules.length > 0) {
                        modules.slice(0, 3).forEach(module => {
                            log('file-log', `  ‚Ä¢ ${module.name}: ${module.description}`, 'info');
                        });
                    }
                } else {
                    log('file-log', `‚ö†Ô∏è Forensic capabilities: ${data.error || 'Access restricted'}`, 'warning');
                }
            } catch (error) {
                log('file-log', `‚ùå Forensic test failed: ${error.message}`, 'error');
            }
        }

        // Credentials functions
        async function loadTestCredentials() {
            log('creds-log', 'Loading test credentials...', 'info');
            setStatus('creds-status', 'warning');
            
            if (authSystem === 'mock') {
                const credsList = document.getElementById('credentials-list');
                credsList.innerHTML = `
                    <h4>Available Test Accounts (Mock System)</h4>
                    <div class="credential-item">
                        <strong>Professional Tier:</strong><br>
                        Email: test@metaextract.com<br>
                        Password: testpassword123
                    </div>
                    <div class="credential-item">
                        <strong>Enterprise Tier:</strong><br>
                        Email: admin@metaextract.com<br>
                        Password: adminpassword123
                    </div>
                    <div class="credential-item">
                        <strong>Forensic Tier:</strong><br>
                        Email: forensic@metaextract.com<br>
                        Password: forensicpassword123
                    </div>
                `;
                
                setStatus('creds-status', 'online');
                log('creds-log', '‚úÖ Test credentials loaded (mock system)', 'success');
            } else {
                const credsList = document.getElementById('credentials-list');
                credsList.innerHTML = `
                    <h4>Database Authentication System</h4>
                    <p>Create new accounts using the registration form above.</p>
                    <div class="credential-item">
                        <strong>Suggested Test Account:</strong><br>
                        Email: test_${Date.now()}@metaextract.com<br>
                        Username: testuser_${Date.now()}<br>
                        Password: testpassword123
                    </div>
                `;
                
                setStatus('creds-status', 'online');
                log('creds-log', '‚úÖ Database system detected - use registration', 'info');
            }
        }

        function useCredentials(tier) {
            if (testCredentials[tier]) {
                const creds = testCredentials[tier];
                document.getElementById('auth-email').value = creds.email;
                document.getElementById('auth-password').value = creds.password;
                log('creds-log', `‚úÖ Loaded ${tier} credentials`, 'success');
            } else {
                log('creds-log', `‚ùå No ${tier} credentials available`, 'error');
            }
        }

        // System info functions
        async function getSystemInfo() {
            log('info-log', 'Gathering system information...', 'info');
            setStatus('info-status', 'warning');
            
            try {
                // Get health info
                const { response: healthResponse, data: healthData } = await apiCall('http://localhost:3000/api/health');
                
                // Get auth status
                const { response: authResponse, data: authData } = await apiCall('http://localhost:3000/api/auth/me');
                
                const systemInfo = document.getElementById('system-info');
                systemInfo.innerHTML = `
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <h4 style="color: #3b82f6; margin: 0 0 10px 0;">System Information</h4>
                        <strong>Server Status:</strong> ${healthResponse.ok ? '‚úÖ Online' : '‚ùå Offline'}<br>
                        <strong>Service:</strong> ${healthData.service || 'Unknown'}<br>
                        <strong>Version:</strong> ${healthData.version || 'Unknown'}<br>
                        <strong>Auth System:</strong> ${authSystem}<br>
                        <strong>Current User:</strong> ${currentUser ? currentUser.username : 'Not logged in'}<br>
                        <strong>Authentication:</strong> ${authData.authenticated ? '‚úÖ Authenticated' : '‚ùå Not authenticated'}
                    </div>
                `;
                
                setStatus('info-status', 'online');
                log('info-log', '‚úÖ System information updated', 'success');
            } catch (error) {
                setStatus('info-status', 'offline');
                log('info-log', `‚ùå Failed to get system info: ${error.message}`, 'error');
            }
        }

        async function testEndpoints() {
            log('info-log', 'Testing API endpoints...', 'info');
            
            const endpoints = [
                { name: 'Health Check', url: '/api/health', method: 'GET' },
                { name: 'Auth Status', url: '/api/auth/me', method: 'GET' },
                { name: 'Tier Info', url: '/api/tiers', method: 'GET' },
                { name: 'Extract Endpoint', url: '/api/extract', method: 'GET' },
                { name: 'Forensic Capabilities', url: '/api/forensic/capabilities', method: 'GET' }
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`http://localhost:3000${endpoint.url}`, { method: endpoint.method });
                    const status = response.ok ? '‚úÖ' : response.status === 405 ? '‚ö†Ô∏è' : '‚ùå';
                    log('info-log', `${status} ${endpoint.name}: ${response.status}`, response.ok ? 'success' : 'warning');
                } catch (error) {
                    log('info-log', `‚ùå ${endpoint.name}: ${error.message}`, 'error');
                }
            }
        }

        // UI functions
        function refreshIframe() {
            const iframe = document.getElementById('frontend-iframe');
            iframe.src = iframe.src;
            log('info-log', 'üîÑ Frontend iframe refreshed', 'info');
        }

        function openInNewTab() {
            window.open('http://localhost:3000', '_blank');
        }

        function openMainApp() {
            window.open('http://localhost:3000', '_blank');
        }

        // Full test runner
        async function runFullTest() {
            const icon = document.getElementById('full-test-icon');
            icon.innerHTML = '<div class="loading"></div>';
            
            clearAllLogs();
            log('server-log', 'üß™ Starting comprehensive authentication test...', 'info');
            
            // Test sequence
            await checkServerHealth();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await detectAuthSystem();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await loadTestCredentials();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            if (authSystem === 'mock') {
                // Test login with professional account
                useCredentials('professional');
                await testLogin();
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            await testAllTiers();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testAdvancedAnalysis();
            await testForensicAnalysis();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await getSystemInfo();
            await testEndpoints();
            
            icon.innerHTML = 'üß™';
            log('server-log', '‚úÖ Comprehensive test completed!', 'success');
        }

        // Initialize on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkServerHealth();
                detectAuthSystem();
            }, 1000);
        });
    </script>
</body>
</html>