#!/bin/bash
# Pre-commit hook to detect suspicious file changes and prevent accidental truncations
# This hook checks for files that have been significantly reduced in size

set -e

# Enforce feature-branch workflow
BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")
if [ "$BRANCH_NAME" = "main" ] || [ "$BRANCH_NAME" = "master" ]; then
    echo "üö´ Direct commits to '$BRANCH_NAME' are not allowed. Use a feature branch."
    exit 1
fi

if ! echo "$BRANCH_NAME" | grep -Eq '^(feat|chore)/[a-z0-9._-]+$'; then
    echo "üö´ Branch name '$BRANCH_NAME' is invalid."
    echo "   Use: feat/<area>-<change> or chore/<area>-<change>"
    exit 1
fi

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "üîç Running pre-commit regression checks..."

# Thresholds
MIN_LINES_TO_CHECK=100  # Only check files that were at least this large
DELETION_THRESHOLD=50   # Warn if more than 50% of lines deleted
CRITICAL_SIZE=50        # Critical if file becomes smaller than this
SUSPICIOUS_RATIO=80     # Suspicious if deletions are 80% or more

# Track issues
WARNINGS=0
ERRORS=0
SUSPICIOUS_FILES=()

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=M)

if [ -z "$STAGED_FILES" ]; then
    echo "‚úÖ No modified files to check"
    exit 0
fi

echo ""
echo "üìä Analyzing $(echo "$STAGED_FILES" | wc -l | tr -d ' ') staged files..."
echo ""

for file in $STAGED_FILES; do
    # Skip files that don't exist in HEAD (new files)
    if ! git cat-file -e HEAD:"$file" 2>/dev/null; then
        continue
    fi
    
    # Get line counts
    OLD_LINES=$(git show HEAD:"$file" 2>/dev/null | wc -l | tr -d ' ')
    NEW_LINES=$(wc -l < "$file" 2>/dev/null | tr -d ' ')
    
    # Skip if old file was small
    if [ "$OLD_LINES" -lt "$MIN_LINES_TO_CHECK" ]; then
        continue
    fi
    
    # Calculate changes
    DELETED_LINES=$((OLD_LINES - NEW_LINES))
    if [ "$OLD_LINES" -gt 0 ]; then
        DELETION_PERCENT=$((DELETED_LINES * 100 / OLD_LINES))
    else
        DELETION_PERCENT=0
    fi
    
    # Check for complete truncation
    if [ "$NEW_LINES" -eq 0 ]; then
        echo -e "${RED}‚ùå CRITICAL: File became EMPTY${NC}"
        echo "   File: $file"
        echo "   Was: $OLD_LINES lines ‚Üí Now: 0 lines"
        echo ""
        ERRORS=$((ERRORS + 1))
        SUSPICIOUS_FILES+=("$file")
        continue
    fi
    
    # Check for severe truncation (file became very small)
    if [ "$NEW_LINES" -lt "$CRITICAL_SIZE" ] && [ "$OLD_LINES" -gt 500 ]; then
        echo -e "${RED}‚ùå CRITICAL: Large file severely truncated${NC}"
        echo "   File: $file"
        echo "   Was: $OLD_LINES lines ‚Üí Now: $NEW_LINES lines"
        echo "   Lost: $DELETED_LINES lines ($DELETION_PERCENT%)"
        echo ""
        ERRORS=$((ERRORS + 1))
        SUSPICIOUS_FILES+=("$file")
        continue
    fi
    
    # Check for suspicious deletion ratio
    if [ "$DELETION_PERCENT" -ge "$SUSPICIOUS_RATIO" ]; then
        echo -e "${RED}‚ö†Ô∏è  SUSPICIOUS: Massive deletion detected${NC}"
        echo "   File: $file"
        echo "   Was: $OLD_LINES lines ‚Üí Now: $NEW_LINES lines"
        echo "   Lost: $DELETED_LINES lines ($DELETION_PERCENT%)"
        echo ""
        WARNINGS=$((WARNINGS + 1))
        SUSPICIOUS_FILES+=("$file")
        continue
    fi
    
    # Check for significant truncation
    if [ "$DELETION_PERCENT" -ge "$DELETION_THRESHOLD" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  WARNING: Significant deletion${NC}"
        echo "   File: $file"
        echo "   Was: $OLD_LINES lines ‚Üí Now: $NEW_LINES lines"
        echo "   Lost: $DELETED_LINES lines ($DELETION_PERCENT%)"
        echo ""
        WARNINGS=$((WARNINGS + 1))
    fi
done

echo ""
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

# Summary
if [ "$ERRORS" -gt 0 ] || [ "$WARNINGS" -gt 0 ]; then
    echo ""
    echo -e "${YELLOW}üìã SUMMARY:${NC}"
    [ "$ERRORS" -gt 0 ] && echo -e "   ${RED}Critical issues: $ERRORS${NC}"
    [ "$WARNINGS" -gt 0 ] && echo -e "   ${YELLOW}Warnings: $WARNINGS${NC}"
    echo ""
fi

# Block commit if critical issues found
if [ "$ERRORS" -gt 0 ]; then
    echo -e "${RED}üö´ COMMIT BLOCKED${NC}"
    echo ""
    echo "Critical file truncations detected. This usually indicates:"
    echo "  ‚Ä¢ Accidental file deletion/truncation"
    echo "  ‚Ä¢ AI agent edit failure (common with large files)"
    echo "  ‚Ä¢ Merge conflict resolution error"
    echo ""
    echo "Affected files:"
    for file in "${SUSPICIOUS_FILES[@]}"; do
        echo "  - $file"
    done
    echo ""
    echo "To review the changes:"
    echo "  git diff --cached $file"
    echo ""
    echo "To restore from previous commit:"
    echo "  git checkout HEAD -- $file"
    echo ""
    echo "To bypass this check (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

# Show warnings but allow commit
if [ "$WARNINGS" -gt 0 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warnings detected but commit allowed${NC}"
    echo ""
    echo "Please review these files carefully before pushing:"
    for file in "${SUSPICIOUS_FILES[@]}"; do
        echo "  - $file"
    done
    echo ""
    echo "Press Ctrl+C to cancel, or wait 3 seconds to continue..."
    sleep 3
fi

echo -e "${GREEN}‚úÖ Pre-commit checks passed${NC}"
echo ""
exit 0
